---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# aphylo2

<!-- badges: start -->
<!-- badges: end -->

The goal of aphylo2 is to ...

## Installation

You can install the released version of aphylo2 from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("aphylo2")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("USCbiostats/aphylo2")
```
## Example

```{r}
library(aphylo2)

# Preparing data
annotations <- replicate(7L, c(9, 9, 9), simplify = FALSE)

# Random tree
set.seed(31)
tree <- aphylo::sim_tree(4)$edge - 1L

duplication <- rep(TRUE, 7)

# Reading the data in
amodel <- new_model(
  annotations = annotations,
  geneid = c(tree[, 2], 4),
  parent = c(tree[, 1], -1),
  duplication = duplication
  )

# Preparing the model
invisible({
  
  term_cogain(amodel, 0, 1)
  term_cogain(amodel, 0, 2)
  term_cogain(amodel, 1, 2)
  term_maxfuns(amodel, 2, 2)
  
  init(amodel)
  
})

# Testing
params <- c(
  # Cogain
  5, 5, -5,
  # max funs
  10, 
  # Root probabilities
  -10, -10, -10
)

likelihood(amodel, params*0)

# Simulating data
fake <- sim_aphylo2(p = amodel, par = params, seed = 1)

amodel <- new_model(
  annotations = fake,
  geneid = tree[, 2],
  parent = tree[, 1],
  duplication = duplication
  )

# Fitting the model

invisible({
  
  term_cogain(amodel, 0, 1)
  term_cogain(amodel, 0, 2)
  term_cogain(amodel, 1, 2)
  term_maxfuns(amodel, 2, 2)
  
  init(amodel)
  
})


# Finding MLE
ans <- optim(params*0, function(f) {
  log(likelihood(amodel, f))
}, control = list(fnscale=-1, maxit = 2e3),
hessian = TRUE)

ans

# Root node probabilities
plogis(tail(ans$par, 3))

# Is it invertible?
diag(MASS::ginv(-ans$hessian))
# diag(solve(-ans$hessian, tol = 1e-100))

# Simulating
ans <- sim_aphylo2(amodel, c(10, 10, -10, 10, -100, -100, -100)/5)
do.call(rbind, ans)

```


## Code of Conduct
  
Please note that the aphylo2 project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
